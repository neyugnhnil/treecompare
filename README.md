# treecompare

treecompare is a Snakemake workflow for exploring multiple phylogenetic tree-building strategies from a single aligned FASTA. It sanitizes user inputs, normalizes configuration, dispatches distance/parsimony/likelihood/Bayesian builders, runs optional topology-based Mantel tests for clustering by feature, and renders HTML outputs. 

It’s a deliberately simplistic and opinionated workflow built to explore multiple tree-building methods with minimal setup. The codebase is a generalized rework of coursework, tuned for exploratory runs on small datasets, though structured so it can scale onto HPC when needed. The pipeline is built to "fail fast": when inputs are missing or invalid, it falls back to sensible defaults, and downstream steps consume sanitized artefacts from upstream steps.

## Overview

- The pipeline can chain UPGMA, NJ, MP, ML (IQ-TREE), and BI (MrBayes) builders in one run, and later trees can reuse earlier topologies via `starter`.
- `scripts/sanitize_inputs.py` rewrites FASTA headers, enforces a consistent gap symbol, emits a header map, and rewrites the metadata table so every downstream rule uses sanitized IDs.
- `scripts/validate_config.py` enforces structure, fills defaults, resolves invalid models, and writes `resources/config.sanitized.yaml`, which Snakemake consumes through `TREECOMPARE_CONFIG`.
- `scripts/mantel.R` correlates tree distances with metadata (always producing `mantel.tsv`, even if disabled), while `workflow/qc.rules` can run AMAS summaries when requested.
- `scripts/render_report.R` combines `report.Rmd` and `tree_report.Rmd` templates to deliver `results/report/index.html` plus per-tree subpages.

## Repository layout

```
treecompare/
├── main.py                # CLI entrypoint
├── Snakefile              # top-level Snakemake DAG
├── scripts/               # validators, builders, renderers
├── workflow/              # rule bundles (sanitize, trees, mantel, etc.)
├── env.yaml               # shared Conda environment
└── test-project           # example project
```

Each project directory (e.g., `test-project/`) is self-contained: it holds the aligned FASTA, optional metadata, `config.yaml`, a `resources/` folder generated by validation, and `results/`. The workflow never writes outside the project root.

## Requirements

- Python 3.10+
- Snakemake available on `PATH`
- Conda (Snakemake uses `env.yaml` to materialize tool environments)
- IQ-TREE, MrBayes
- (optionally) AMAS.

## Pipeline flow

1. **Config validation**: `scripts/validate_config.py` loads `config.yaml`, checks `data`, `runtime`, `mantel`, and `trees`, coerces booleans, validates FASTA content via `scripts/fasta.py`, and writes `resources/config.sanitized.yaml` plus warnings for corrected values.
2. **Data label sanitization**: `workflow/sanitize.rules` calls `scripts/sanitize_inputs.py` to produce:
   - `resources/alignment.sanitized.fasta`
   - `resources/metafile.sanitized.tsv`
   - `resources/header_map.tsv`
3. **Optional QC**: When `data.post_alignment_qc` is true, `workflow/qc.rules` runs AMAS on the sanitized FASTA and saves `results/qc/alignment_qc.txt`.
4. **Tree construction**: `workflow/trees.rules` invokes `scripts/dispatcher.py` per tree spec. The dispatcher evaluates the method, RNG seed, and starter dependency before running the matching backend (`build_dist_tree.R`, `build_mp.R`, `run_iqtree.sh`, or `run_mrbayes.sh`). Each tree yields `results/<tree>/tree.nwk`, `stats.json`, and `build.log`.
5. **Mantel analysis**: `workflow/mantel.rules` guarantees `results/<tree>/mantel.tsv`. When Mantel is enabled and sanitized metadata exists, `scripts/mantel.R` computes correlations; otherwise a header-only placeholder keeps downstream steps satisfied.
6. **Reporting**: `workflow/report.rules` feeds all trees, stats, Mantel tables, and the header map into `scripts/render_report.R`, producing `results/report/index.html` plus per-tree HTML reports.

## Usage

1. **Create and activate the Conda environment** (once per machine):

   ```bash
   cd treecompare
   conda env create -f env.yaml
   conda activate treecompare
   ```

2. **Create a project directory** at the repo root:

   ```
   myproj/
   ├── aligned.fasta            # aligned FASTA with DNA or AA sequences
   ├── metafile.tsv             # optional TSV, first column = FASTA headers
   └── config.yaml              # see Configuration below
   ```

   A config.yaml template can be copied from the repo root or `test-project/`.

3. **Validate and run**:

   ```bash
   cd treecompare
   python3 main.py myproj [--yes]
   ```

   `main.py` runs the validator (auto-accept warnings when `--yes`), then launches Snakemake with `resources/config.sanitized.yaml`, exposing it via `TREECOMPARE_CONFIG`.

4. **Inspect outputs**:
   - Per tree: `results/<tree>/tree.nwk`, `stats.json`, `mantel.tsv`, `build.log`
   - Optional QC: `results/qc/alignment_qc.txt` (tab-separated)
   - Reports: `results/report/index.html` plus `results/report/<tree>.html`

## Configuration

`config.yaml` drives everything and is normalized before Snakemake sees it.

- **data**
  - `fasta` (required): aligned FASTA with ≥3 unique headers.
  - `metafile` (optional): TSV with a header row; column 1 must match FASTA headers.
  - `datatype`: `"dna"` or `"aa"`.
  - `gap_symbol`: single character present in the alignment (default `"-"`).
  - `post_alignment_qc`: whether to run AMAS summaries.
- **runtime**
  - `seed`: positive integer used for MP/ML/BI reproducibility; omit for tool defaults.
- **mantel**
  - `enabled`: toggle Mantel analysis.
  - `method`: `"spearman"` or `"pearson"`.
  - `permutations`: number of randomizations (default 1000).
- **trees**
  - Ordered list of tree specs, each with a unique `name` and `method`.
  - Optional per-method fields:
    - UPGMA/NJ: `model` (defaults DNA=`JC69`, AA=`JTT`).
    - MP: `starter` (`"random"` or another tree’s name).
    - ML: `model` (DNA=`GTR+F+R4`, AA=`LG+F+R4` by default), `starter`.
    - BI: `model` (DNA=`GTR+G`, AA=`LG` by default), `starter`, `burninfrac`.

Invalid or missing entries are replaced with defaults, and the sanitized configuration stored in `resources/config.sanitized.yaml` is what the workflow actually consumes.

## Troubleshooting

- **Snakemake missing** – Install Snakemake or pass `--snakemake /path/to/snakemake` to `main.py`.
- **IQ-TREE / MrBayes errors** – Review `results/<tree>/build.log`; invalid models are auto-corrected during validation but downstream tools may still reject unsupported combinations.
- **QC output empty** – AMAS writes a failure message to `results/qc/alignment_qc.txt` if it cannot summarize the sanitized FASTA.

## Example

`test-project` contains internal transcribed spacer (ITS1) sequence data (`aligned-Kochanova.fasta`) and a metadata table covering locality, shore, substrate, and morphometrics derived from the Lake Baikal dataset described by Kochanova et al. (2024). Running:

```bash
python3 main.py test-project --yes
```

sanitizes the FASTA/metadata, normalizes the config, builds UPGMA, NJ, ML, MP, and BI trees (respecting starter dependencies), runs Mantel tests for each, and renders the consolidated report under `results/report/`. A folder with example html outputs can be found in `test-project`.

## References

Kochanova, E., Mayor, T., & Väinölä, R. (2024). Cryptic diversity and speciation in an endemic copepod crustacean *Harpacticella inopinata* within Lake Baikal. *Ecology and Evolution, 14*, e11471. https://doi.org/10.1002/ece3.11471
